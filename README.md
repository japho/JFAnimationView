## å‰è¨€

åœ¨å¼€å‘APPçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åœ¨APPä¸­å®ç°è®¾è®¡åŒå­¦çš„UEæ•ˆæœåŠ¨ç”»ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ä»£ç å®ç°çš„ï¼Œå½“å¯¹äºè¾ƒå¤æ‚çš„åŠ¨ç”»æ—¶ï¼Œä¾‹å¦‚ç›´æ’­ä¸­åˆ·ç¤¼ç‰©æ—¶çš„åŠ¨ç”»ï¼Œè¿™æ—¶åˆ©ç”¨ä»£ç å®ç°ä¼šæ¯”è¾ƒå¤æ‚ã€‚è€Œä¸”`Android`å’Œ`iOS`ä¸¤ç«¯ä¸å¥½ç»Ÿä¸€æ•ˆæœï¼Œå¦‚æœç”¨gifå›¾ç‰‡æ¥å®ç°çš„è¯ï¼Œåœ¨å›¾ç‰‡å¤§å°å’ŒåŠ¨ç”»å¸§æ•°ä¹‹é—´å¾ˆéš¾æƒè¡¡ã€‚è€Œä¸”ä¼šå¯¼è‡´å†…å­˜åƒç´§ã€‚ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œä»Šå¤©æ¥ä»‹ç»ä¸¤æ¬¾å®ç°å¤æ‚åŠ¨ç”»çš„å¼€æºåº“ï¼š`Lottie`å’Œ`SVGA`ã€‚

## Lottie 

>Lottie is a mobile library for Android and iOS that parses Adobe After Effects animations exported as json with bodymovin and renders the vector animations natively on mobile and through React Native!

å¤§è‡´æ„æ€æ˜¯ï¼š`Lottie`æ˜¯ä¸€ä¸ªå¯ä»¥è§£æä½¿ç”¨ã€[bodymovin](https://github.com/airbnb/lottie-web)ã€‘æ’ä»¶ä» `Adobe After Effects` ä¸­å¯¼å‡ºçš„æ ¼å¼ä¸º`json`çš„æ–‡ä»¶ï¼Œå¹¶åœ¨`iOS`ã€`Android`ã€`macOS`ã€`React Native`ä¸­è¿›è¡Œè§£æä½¿ç”¨çš„å¼€æºåº“ã€‚

[å®˜æ–¹é“¾æ¥](https://github.com/airbnb/lottie-ios)

éƒ¨åˆ†æ•ˆæœï¼š

![](https://upload-images.jianshu.io/upload_images/1722373-7bf8a4735413147c.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/800/format/webp)

![](https://upload-images.jianshu.io/upload_images/1722373-2f17af8843802c88.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/800/format/webp)

### ä¼˜ç‚¹&&ç¼ºç‚¹

**ä¼˜ç‚¹ï¼š**

- å¼€å‘æˆæœ¬ä½ï¼Œè®¾è®¡å¸ˆå¯¼å‡ºjsonåï¼Œå¼€å‘åŒå­¦åªéœ€å¼•ç”¨æ–‡ä»¶å³å¯ã€‚
- æ”¯æŒæœåŠ¡ç«¯URLåˆ›å»ºï¼ŒæœåŠ¡ç«¯å¯ä»¥é…ç½®`json`æ–‡ä»¶ï¼Œéšæ—¶æ›¿æ¢åŠ¨ç”»ã€‚
- æ€§èƒ½æå‡ï¼Œæ›¿æ¢åŸä½¿ç”¨å¸§å›¾å®Œæˆçš„åŠ¨ç”»ï¼ŒèŠ‚çœå®¢æˆ·ç«¯ç©ºé—´å’Œå†…å­˜ã€‚
- è·¨å¹³å°ï¼Œ`iOS`ã€`Android`ä½¿ç”¨ä¸€å¥—æ–¹æ¡ˆï¼Œæ•ˆæœç»Ÿä¸€ã€‚
- æ”¯æŒè½¬åœºåŠ¨ç”»

**ç¼ºç‚¹ï¼š**

- å¯¹æŸäº›AEå±æ€§ä¸æ”¯æŒã€‚
- å¯¹å¹³å°æœ‰é™åˆ¶ï¼ŒiOS 8.0 ä»¥ä¸Šï¼ŒAndroid API 14 ä»¥ä¸Šã€‚
- äº¤äº’åŠ¨ç”»ä¸å¯è¡Œï¼Œä¸»è¦æ˜¯æ’­æ”¾ç±»å‹åŠ¨ç”»ã€‚

### é›†æˆLottie

å®˜æ–¹åœ°å€ï¼š[https://github.com/airbnb/lottie-ios](https://github.com/airbnb/lottie-ios)ï¼Œgithub ä¸­æœ‰ Demo æä¾›å­¦ä¹ ã€‚

é›†æˆæ–¹æ³•å¯ä»¥ä½¿ç”¨Cocoapodsï¼Œæˆ–æ‰‹åŠ¨é›†æˆã€‚

**Cocoapodsé›†æˆ**

ä¸€ã€åœ¨podfileä¸­æ·»åŠ ï¼š

```
pod 'lottie-ios'
```
äºŒã€è¿è¡Œ

```
pod install
```

å‡å¦‚ä½ çš„é¡¹ç›®ä¹‹å‰é›†æˆè¿‡å…¶ä»–ä¸‰æ–¹ï¼Œæ¯”å¦‚`Masonry`ï¼Œè¿™ä¸ªæ—¶å€™ä½ ç¼–è¯‘é¡¹ç›®ï¼Œå¯èƒ½ä¼šæŠ¥`code1`é”™è¯¯ï¼Œå½“ç„¶æ²¡æŠ¥é”™æœ€å¥½ã€‚ç¨å®‰å‹¿èºï¼Œäººå®¶å®˜æ–¹æ–‡æ¡£è¯´äº†ï¼Œè¿˜å¾—å®‰è£…`Carthage`ã€‚

>**å®‰è£…Carthage**
>
>```
>brew install carthage
>```
>
>**ä½¿ç”¨Carthageå®‰è£…ä¾èµ–**
>
>1ã€å‰å¾€æ–‡ä»¶å¤¹
>
>```
>cd ~/è·¯å¾„/é¡¹ç›®æ–‡ä»¶å¤¹
>```
>
>2ã€åˆ›å»ºä¸€ä¸ªç©ºçš„ Carthage æ–‡ä»¶ Cartfile
>
>```
>touch Cartfile
>```
>
>3ã€ä½¿ç”¨ Xcode æ‰“å¼€ Cartfile æ–‡ä»¶
>
>```
>open -a Xcode Cartfile
>```
>
>4ã€åœ¨cartfileé‡Œé¢åŠ ä¸€è¡Œä»£ç 
>
>```
>github "airbnb/lottie-ios" "master"
>```
>
>5ã€ç»ˆç«¯æ‰§è¡Œæ›´æ–°å‘½ä»¤
>
>```
>carthage update --platform iOS
>```

**æ‰‹åŠ¨é›†æˆLottie**

å°†`demo`ä¸­çš„`lottie-ios`æ–‡ä»¶å¤¹æ‹–å…¥é¡¹ç›®ä¸­å³å¯

### Lottieçš„ä½¿ç”¨

Lottieå¤´æ–‡ä»¶ï¼š

`LOTAnimationView.h`

```swift
//åˆ›å»ºè§†å›¾çš„å‡ ä¸ªæ–¹æ³•
+ (instancetype)animationNamed:(NSString *)animationName NS_SWIFT_NAME(init(name:));
+ (instancetype)animationNamed:(NSString *)animationName inBundle:(NSBundle *)bundle NS_SWIFT_NAME(init(name:bundle:));
+ (instancetype)animationFromJSON:(NSDictionary *)animationJSON NS_SWIFT_NAME(init(json:));
- (instancetype)initWithContentsOfURL:(NSURL *)url;

//å¯ç”¨å±æ€§
@property(nonatomic,readonly)BOOLisAnimationPlaying;   //æ˜¯å¦æ­£åœ¨åŠ¨ç”»
@property(nonatomic,assign)BOOLloopAnimation;          //æ˜¯å¦å¾ªç¯æ’­æ”¾åŠ¨ç”»
@property(nonatomic,assign)CGFloatanimationProgress;   //åŠ¨ç”»æ‰§è¡Œè¿›åº¦
@property(nonatomic,assign)CGFloatanimationSpeed;      //åŠ¨ç”»é€Ÿåº¦
@property(nonatomic,readonly)CGFloatanimationDuration; //åŠ¨ç”»æ—¶é—´

//å®ä¾‹æ–¹æ³•
- (void)playWithCompletion:(LOTAnimationCompletionBlock)completion;//åŠ¨ç”»ç»“æŸåå¯ä»¥æ‰§è¡Œä¸€ä¸ªblock
- (void)play;    //æ’­æ”¾
- (void)pause;   //æš‚åœ
- (void)addSubview:(LOTView *)view toLayerNamed:(NSString *)layer;

#if !TARGET_OS_IPHONE && !TARGET_IPHONE_SIMULATOR
@property(nonatomic) LOTViewContentMode contentMode;//éiOSçš„contentMode
#endif
```

æœ€ç®€å•ç²—æš´çš„æ–¹å¼å°±æ˜¯`LOTAnimationView`æ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼ï¼š

```swift
LOTAnimationView *animation = [LOTAnimationView animationNamed:@"Lottie"];
[self.view addSubview:animation];
[animation playWithCompletion:^(BOOL animationFinished) {
  // Do Something
}];
```

å½“ä½ ä½¿ç”¨äº†å¤šä¸ª`bundle`æ–‡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

```swift
LOTAnimationView *animation = [LOTAnimationView animationNamed:@"Lottie" inBundle:[NSBundle YOUR_BUNDLE]];
[self.view addSubview:animation];
[animation playWithCompletion:^(BOOL animationFinished) {
  // Do Something
}];
```

æˆ–è€…ä½¿ç”¨URLè¿›è¡ŒåŠ¨æ€åŠ è½½ï¼Œæ³¨æ„è¿™é‡Œjsonæ–‡ä»¶çš„å›¾ç‰‡åˆ™éœ€è¦ä½¿ç”¨ç½‘ç»œå›¾ç‰‡ï¼š

```swift
LOTAnimationView *animation = [[LOTAnimationView alloc] initWithContentsOfURL:[NSURL URLWithString:URL]];
[self.view addSubview:animation];
```

æ•ˆæœï¼š

æ„Ÿè°¢è€é“çš„ç«å±±ï¼

![](https://ws1.sinaimg.cn/large/006tNbRwly1fwyesgf1kdg309m0jq4qr.gif)

## SVGA

[å®˜æ–¹é“¾æ¥](http://svga.io/)

SVGAConverter å¯ä»¥å°† Flash ä»¥åŠ After Effects åŠ¨ç”»å¯¼å‡ºæˆ .SVGA æ–‡ä»¶ï¼ˆå®é™…ä¸Šæ˜¯ ZIP åŒ…ï¼‰ï¼Œä¾› SVGAPlayer åœ¨å„å¹³å°æ’­æ”¾ï¼ŒSVGAPlayer æ”¯æŒåœ¨ iOS / Android / Web / ReactNative / LayaBox ç­‰å¹³å°ã€æ¸¸æˆå¼•æ“æ’­æ”¾ã€‚

SVGA åšçš„äº‹æƒ…ï¼Œå®é™…ä¸Šï¼Œéå¸¸ç®€å•ï¼ŒConverter ä¼šè´Ÿè´£ä» Flash æˆ– AE æºæ–‡ä»¶ä¸­æå–æ‰€æœ‰åŠ¨ç”»å…ƒç´ ï¼ˆä½å›¾ã€çŸ¢é‡ï¼‰ï¼Œå¹¶å°†å…¶åœ¨æ—¶é—´è½´ä¸­çš„æ¯å¸§è¡¨ç°ï¼ˆä½ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ã€é€æ˜åº¦ï¼‰å¯¼å‡ºã€‚ Player ä¼šè´Ÿè´£å°†è¿™äº›ä¿¡æ¯è¿˜åŸè‡³ç”»å¸ƒä¸Šã€‚

å› æ­¤ï¼Œä½ ä¼šå‘ç°ï¼ŒSVGA æ—¢æœ‰åºåˆ—å¸§çš„ç‰¹ç‚¹ï¼Œåˆæœ‰å…ƒç´ åŠ¨ç”»çš„ç‰¹ç‚¹ã€‚Player é€»è¾‘æåº¦ç®€å•ï¼Œå¥¹åªè´Ÿè´£ç²—æš´åœ°å°†æ¯ä¸€ä¸ªå…ƒç´ ï¼Œä¸æ¯«ä¸å·®åœ°æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œè€Œæ— é¡»ä»»ä½•æ’å€¼è®¡ç®—ã€‚ï¼ˆæˆ‘ä»¬è®¤ä¸ºï¼Œä»»ä½•æ’ä»¶è®¡ç®—çš„é€»è¾‘éƒ½æ˜¯å¤æ‚çš„ï¼‰

ä¹Ÿå› æ­¤ï¼Œä½ ä¼šå‘ç°ï¼ŒSVGA ä¸åŒäº Lottieï¼ŒLottie éœ€è¦åœ¨ Player ä¸€å±‚å®Œæ•´åœ°å°† After Effects æ‰€æœ‰é€»è¾‘å®ç°ï¼Œè€Œ SVGA åˆ™å°†è¿™äº›é€»è¾‘å…å»ã€‚ä¹Ÿå› æ­¤ï¼ŒSVGA å¯ä»¥åŒæ—¶æ”¯æŒ Flashï¼Œæˆ‘ä»¬ç›¸ä¿¡ Flash ä»¥åŠå…¶ç»§æ‰¿è€… Animate CC ä»ç„¶æœ‰å¼ºå¤§çš„ç”Ÿå‘½åŠ›ï¼Œä»¥åŠå®Œå–„çš„è®¾è®¡ç”Ÿæ€ã€‚

SVGA æœ€åˆçš„ç›®æ ‡æ˜¯ä¸ºé™ä½åºåˆ—å¸§åŠ¨ç”»å¼€é”€è€Œç”Ÿçš„ï¼Œå› æ­¤ï¼Œæ€§èƒ½é—®é¢˜ä¸€ç›´æ˜¯ SVGA å…³æ³¨çš„ç„¦ç‚¹ã€‚å¦‚æœä½ å¯ä»¥æ·±å…¥åœ°æ¢ç©¶ SVGA çš„å®ç°æ–¹å¼ï¼Œä½ ä¼šå‘ç°ï¼ŒSVGA å®è´¨ä¸Šåšäº†ä¸€ä»¶éå¸¸é‡è¦çš„äº‹æƒ…ã€‚å¥¹ä¼šåœ¨åŠ¨ç”»æ’­æ”¾å‰ï¼Œä¸€æ¬¡æ€§åœ°ä¸Šä¼ æ‰€æœ‰çº¹ç†åˆ° GPUï¼Œæ¥ç€ï¼Œåœ¨æ’­æ”¾çš„è¿‡ç¨‹ä¸­ï¼Œè¿™äº›çº¹ç†ä¼šè¢«é‡å¤ä½¿ç”¨ã€‚CPU ä¸ GPU äº¤æ¢çš„æ¬¡æ•°å¤§å¤§å‡å°‘ï¼ŒåŒæ—¶ï¼Œçº¹ç†çš„æ•°ç›®ä¹Ÿåœ¨å¯æ§èŒƒå›´ã€‚å†…å­˜ã€CPUã€GPU å ç”¨èƒ½è¾¾åˆ°æœ€ä¼˜çŠ¶æ€ã€‚

### SVGAçš„é›†æˆ

å®˜æ–¹ GitHubï¼š[https://github.com/yyued/SVGAPlayer-iOS](https://github.com/yyued/SVGAPlayer-iOS), GitHub ä¸­æœ‰ Demo æä¾›å­¦ä¹ ã€‚

ä¸€ã€åœ¨podfileä¸­æ·»åŠ ï¼š

```
pod 'SVGAPlayer'
```
äºŒã€è¿è¡Œ

```
pod install
```

### æ‰‹åŠ¨é›†æˆè¸©é›·

å› ä¸ºé¡¹ç›®ä¸­æœªä½¿ç”¨ Cocoapods ï¼Œæ‰€ä»¥è¦æ±‚æ‰‹åŠ¨é›†æˆ SVGA åˆ°é¡¹ç›®ä¸­ï¼Œä½†æ˜¯å®˜æ–¹ä»…æä¾›äº† pods çš„é›†æˆæ–¹æ³•ï¼Œä¸‹é¢æ¥è¯´ä¸‹æ‰‹åŠ¨é›†æˆçš„é—®é¢˜ï¼š

1ã€åœ¨ [GitHub](https://github.com/yyued/SVGAPlayer-iOS)ä¸­ä¸‹è½½é¡¹ç›®å·¥ç¨‹ï¼Œå°†ä»¥ä¸‹æ–‡ä»¶å¤¹å¯¼å…¥å·¥ç¨‹ï¼š

>`Protobuf`,`SSZipArchive`,`SVGAPlayer`

æ­¤æ—¶ build å¯èƒ½ä¼šæŠ¥é”™å¤´æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡‡ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

>Targets -> Build Settings -> Header Search Pahts æ·»åŠ è·¯å¾„

```
"$(SRCROOT)/JFAnimationDemo/Libs/Protobuf/objectivec"
"$(SRCROOT)/JFAnimationDemo/Libs/SSZipArchive"
```

`æ³¨æ„ï¼š`è¿™é‡Œæ ¹æ®é¡¹ç›®ä¸­å…·ä½“ç±»çš„ä½ç½®è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚

è§£å†³å¤´æ–‡ä»¶ä¸å­˜åœ¨é—®é¢˜ä¹‹åï¼Œä¸‹é¢å¯èƒ½ä¼šå‡ºç°å†…å­˜ç®¡ç†æ–¹æ³•ä¸å¯è°ƒç”¨çš„é—®é¢˜ã€‚è¿™æ˜¯å› ä¸ºä»£ç åº“ä¸­çš„éƒ¨åˆ†ç±»ä½¿ç”¨çš„æ˜¯éARCï¼Œæ‰€ä»¥éœ€è¦å¯¹éƒ¨åˆ†ç±»è¿›è¡Œé…ç½®ï¼š

>Targets -> Build Phrases -> Compile Sources ä¿®æ”¹ä»¥ä¸‹ç±»çš„ Compiler Flags
>
>è®¾ç½® Compiler Flags ä¸º `-fno-objc-arc`

>`GPBCodedOutputStream.m`,
`GPBCodedInputStream.m`,
`GPBUnknownFieldSet.m`,
`GPBUtilities.m`,
`GPBExtensionInternals.m`,
`GPBArray.m`,
`GPBRootObject.m`,
`GPBExtensionRegistry.m`,
`GPBDescriptor.m`,
`Struct.pbobjc.m`,
`GPBWellKnownTypes.m`,
`Svga.pbobjc.m`,
`GPBDictionary.m`,
`Type.pbobjc.m`,
`GPBMessage.m`,
`GPBUnknownField.m`

### SVGAçš„ä½¿ç”¨

é¦–å…ˆåˆå§‹åŒ– `SVGAPlayer` å¯¹è±¡ï¼š

```swift
- (SVGAPlayer *)svgaPlayer
{
    if (!_svgaPlayer)
    {
        _svgaPlayer = [[SVGAPlayer alloc] init];
        _svgaPlayer.frame = self.bounds;
        _svgaPlayer.loops = 1;
        _svgaPlayer.clearsAfterStop = YES;
        _svgaPlayer.delegate = self;
    }
    
    return _svgaPlayer;
}
```

ç„¶ååˆå§‹åŒ– `SVGAParser` å¯¹è±¡ï¼š

```swift
- (SVGAParser *)svgaParser
{
    if (!_svgaParser)
    {
        _svgaParser = [[SVGAParser alloc] init];
    }
    
    return _svgaParser;
}
```

åŠ è½½åŠ¨ç”»ï¼Œä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š

- URLã€Request
- Data
- Name

`SVGAParser.h` å¤´æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹æ–¹æ³•ï¼š

```swift
- (void)parseWithURL:(nonnull NSURL *)URL
     completionBlock:(void ( ^ _Nonnull )(SVGAVideoEntity * _Nullable videoItem))completionBlock
        failureBlock:(void ( ^ _Nullable)(NSError * _Nullable error))failureBlock;

- (void)parseWithURLRequest:(nonnull NSURLRequest *)URLRequest
            completionBlock:(void ( ^ _Nonnull )(SVGAVideoEntity * _Nullable videoItem))completionBlock
               failureBlock:(void ( ^ _Nullable)(NSError * _Nullable error))failureBlock;

- (void)parseWithData:(nonnull NSData *)data
             cacheKey:(nonnull NSString *)cacheKey
      completionBlock:(void ( ^ _Nullable)(SVGAVideoEntity * _Nonnull videoItem))completionBlock
         failureBlock:(void ( ^ _Nullable)(NSError * _Nonnull error))failureBlock;

- (void)parseWithNamed:(nonnull NSString *)named
              inBundle:(nullable NSBundle *)inBundle
       completionBlock:(void ( ^ _Nullable)(SVGAVideoEntity * _Nonnull videoItem))completionBlock
          failureBlock:(void ( ^ _Nullable)(NSError * _Nonnull error))failureBlock;
```

è°ƒç”¨æ­¤æ–¹æ³•åï¼Œå°†è¿”å›çš„ `videoItem` å¯¹è±¡èµ‹å€¼ï¼Œç„¶åå¼€å§‹åŠ è½½åŠ¨ç”»ï¼š

```swift
__weak __typeof(&*self)weakSelf = self;

[self.svgaParser parseWithNamed:self.animationName inBundle:nil completionBlock:^(SVGAVideoEntity * _Nonnull videoItem) {
                
	__strong __typeof(self)strongSelf = weakSelf;
	strongSelf.svgaPlayer.videoItem = videoItem;
	[strongSelf.svgaPlayer startAnimation];
                
} failureBlock:^(NSError * _Nonnull error) {
                
	NSLog(@"Error: %@",error);
                
}];
```

**æ•ˆæœï¼š**

æ„Ÿè°¢è€é“çš„é¦™å»ï¼

![](https://ws4.sinaimg.cn/large/006tNbRwly1fwyfwpw7t2g309m0jqkbn.gif)

### One More Thing

SVGA çš„å®˜æ–¹åº“ä¸­æä¾›äº†æ›¿æ¢å›¾å±‚çš„ API ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ

å¯èƒ½æˆ‘ä»¬ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼šæˆ‘ä»¬æ‰€éœ€è¦çš„åŠ¨ç”»ä¸­ï¼Œéƒ¨åˆ†å›¾å±‚æ˜¯éœ€è¦å¯é…ç½®çš„ï¼Œä¾‹å¦‚ä»¥ä¸‹æ•ˆæœï¼š

![](https://ws4.sinaimg.cn/large/006tNbRwly1fwygdezcjng308a08g75k.gif)

éœ€æ±‚è¦æ±‚é…å¯¹åŒæ–¹çš„å¤´åƒå¯é…ç½®ï¼Œè€Œä¸”éœ€é…ç½®ä»–ä»¬çš„ç”¨æˆ·åï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå®ç°ã€‚

```swift
#pragma mark - Dynamic Object

- (void)setImage:(UIImage *)image forKey:(NSString *)aKey;
- (void)setImageWithURL:(NSURL *)URL forKey:(NSString *)aKey;
- (void)setImage:(UIImage *)image forKey:(NSString *)aKey referenceLayer:(CALayer *)referenceLayer; // deprecated from 2.0.1
- (void)setAttributedText:(NSAttributedString *)attributedText forKey:(NSString *)aKey;
```

è¿™é‡Œçš„ key æ˜¯äº‹å…ˆå’Œè®¾è®¡åŒå­¦å•†å®šçš„ï¼Œä¹Ÿå¯ä»¥æ‹¿åˆ° SVGA æ–‡ä»¶åè¿›è¡Œè§£æï¼Œè¿™é‡Œå®˜ç½‘æä¾›äº†ä¸€ä¸ªåœ¨çº¿çš„è§£æç½‘å€ï¼š[http://svga.io/svga-preview.html](http://svga.io/svga-preview.html),

å¯ä»¥è§£æ SVGA æ–‡ä»¶ä¸­ç”¨æˆ·å¤´åƒçš„å›¾å±‚åç§°ä¸º â€œuser1â€ è°ƒç”¨ç›¸åº”æ–¹æ³•è¿›è¡Œæ›¿æ¢å³å¯ã€‚

![](https://ws1.sinaimg.cn/large/006tNbRwly1fwygi4g5lkj31kw0v5gt3.jpg)

æ›¿æ¢å›¾å±‚ä¹‹åçš„æ•ˆæœï¼š

![](https://ws3.sinaimg.cn/large/006tNbRwly1fwyglyds7jg308a08gdhx.gif)

## The Last 

é¡¹ç›®ä¸­åŒæ—¶é›†æˆäº† SVGAã€Lottie ä¸¤å¥—ä»£ç åº“ï¼Œä¸ºäº†å¹³æ—¶æ›´é«˜æ•ˆçš„è¿›è¡Œå¼€å‘ï¼Œå°†å…¶å°è£…ä¸ºåŒä¸€å·¥å…·ç±»ï¼Œæš´éœ²å‡ºå…±æœ‰éƒ¨åˆ†ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚å†™çš„ä¸å¥½çš„åœ°æ–¹ï¼Œå¤§å®¶å¤šææ„è§ğŸ˜‰


`JFAnimationView.h`

```swift
//
//  JFAnimationView.h
//  AnimationDemo
//
//  Created by Japho on 2018/10/31.
//  Copyright Â© 2018 Japho. All rights reserved.
//

#import <UIKit/UIKit.h>
#import "SVGAPlayer.h"

NS_ASSUME_NONNULL_BEGIN

@class JFAnimationView;

typedef NS_ENUM(NSUInteger, JFAnimationType) {
    AnimationTypeSVGA = 0,
    AnimationTypeLottie
};

typedef void (^JFAnimationCompletionBlock)(BOOL animationFinished);
typedef void (^JFAnimationResourceCompletionBlcok)(CGRect animationBounds, BOOL loadFinished);

@protocol JFAnimationViewDelegate <NSObject>


/**
 åŠ¨ç”»ç»“æŸå›è°ƒä»£ç†

 @param animationView åŠ¨ç”»è§†å›¾
 */
- (void)animationViewDidFinishedAnimation:(JFAnimationView *)animationView;


/**
 åŠ¨ç”»è°ƒç”¨å¤±è´¥

 @param animationView åŠ¨ç”»è§†å›¾
 */
- (void)animationViewDidFailed:(JFAnimationView *)animationView;

@end

@interface JFAnimationView : UIView

@property (nonatomic, assign) JFAnimationType animationType; //åœ¨è®¾ç½®å…¶ä»–å±æ€§ä¹‹å‰ï¼Œéœ€è®¾ç½®æ­¤å±æ€§
@property (nonatomic, assign) BOOL loopAnimation;   //åŠ¨ç”»æ˜¯å¦å¾ªç¯
@property (nonatomic, assign) id<JFAnimationViewDelegate> delegate;
@property (nonatomic, copy) JFAnimationCompletionBlock completionBlock; //åŠ¨ç”»å®Œæˆå›è°ƒblock
@property (nonatomic, copy) JFAnimationResourceCompletionBlcok resourceComplitionBlock; //åŠ¨ç”»èµ„æºåŠ è½½å®ŒæˆåŠ¨ç”»


/**
 ç±»åˆå§‹åŒ–æ–¹æ³•

 @param frame frame
 @param animationType åŠ¨ç”»ç±»å‹
 @return åŠ¨ç”»è§†å›¾
 */
+ (instancetype)animationViewWithFrame:(CGRect)frame animationType:(JFAnimationType)animationType;

/**
 å¯¹è±¡åˆå§‹åŒ–æ–¹æ³•

 @param frame frame
 @param animationType åŠ¨ç”»ç±»å‹
 @return åŠ¨ç”»è§†å›¾
 */
- (instancetype)initWithFrame:(CGRect)frame animationType:(JFAnimationType)animationType;

/**
 è®¾ç½®æœ¬åœ°åŠ¨ç”»èµ„æº

 @param name æœ¬åœ°åŠ¨ç”»åç§°
 @param bundle å›¾ç‰‡bundle
 @param resourceComplition èµ„æºåŠ è½½å®Œæˆå›è°ƒ è¿”å›åŠ¨ç”»boundsï¼ŒåŠæ˜¯å¦åŠ è½½å®ŒæˆçŠ¶æ€ï¼ˆå®ŒæˆçŠ¶æ€åªæœ‰SVGAä¼šè¿”å›ï¼‰
 */
- (void)setAnimationResourceWithName:(NSString *)name bundle:(NSBundle *)bundle resourceCompliton:(JFAnimationResourceCompletionBlcok)resourceComplition;

/**
 è®¾ç½®ç½‘ç»œåŠ¨ç”»èµ„æº

 @param urlString urlString
 @param resourceComplition èµ„æºåŠ è½½å®Œæˆå›è°ƒ è¿”å›åŠ¨ç”»boundsï¼ŒåŠæ˜¯å¦åŠ è½½å®ŒæˆçŠ¶æ€ï¼ˆå®ŒæˆçŠ¶æ€åªæœ‰SVGAä¼šè¿”å›ï¼‰
 */
- (void)setAnimationResourceWithUrlString:(NSString *)urlString resourceComplition:(JFAnimationResourceCompletionBlcok)resourceComplition;

/**
 å¼€å§‹åŠ¨ç”»
 */
- (void)startAnimating;


/**
 ç»“æŸåŠ¨ç”»
 */
- (void)stopAnimating;


/**
 å¼€å§‹åŠ¨ç”»

 @param completion åŠ¨ç”»å®Œæˆåå›è°ƒ ï¼ˆåªæœ‰Lottieä¼šè¿”å›æ˜¯å¦æˆåŠŸçŠ¶æ€ï¼‰
 */
- (void)startAnimatingWithCompletion:(JFAnimationCompletionBlock)completion;


/**
 æ›¿æ¢SGVAåŠ¨ç”»ä¸­çš„å›¾ç‰‡

 è§£æSVGAèµ„æºæ–‡ä»¶ï¼šhttp://svga.io/svga-preview.html
 
 @param image å°†è¦æ›¿æ¢çš„èµ„æºå›¾ç‰‡
 @param key SVGAåŠ¨ç”»ä¸­è¢«æ›¿æ¢èµ„æºå›¾ç‰‡çš„key
 */
- (void)setImage:(UIImage *)image forSVGAAnimationWithKey:(NSString *)key;


/**
 è®¾ç½®SVGAåŠ¨ç”»ä¸­å›¾ç‰‡ä¸Šæ–¹æ–‡å­—

 è§£æSVGAèµ„æºæ–‡ä»¶ï¼šhttp://svga.io/svga-preview.html
 
 @param attributedText attributedText
 @param key SVGAåŠ¨ç”»ä¸­æ·»åŠ æ–‡å­—äºèµ„æºå›¾ç‰‡çš„key
 */
- (void)setAttributedText:(NSAttributedString *)attributedText forSVGAAnimationWithKey:(NSString *)key;


/**
 è®¾ç½®SVGAåŠ¨ç”»ä¸­æ›¿æ¢Layer
 
 è§£æSVGAèµ„æºæ–‡ä»¶ï¼šhttp://svga.io/svga-preview.html

 @param drawingBlock å°†è‡ªå®šä¹‰Layeræ·»åŠ è‡³contentLayerä¸Š
 @param key SVGAåŠ¨ç”»ä¸­æ›¿æ¢layerçš„key
 */
- (void)setDrawingBlock:(SVGAPlayerDynamicDrawingBlock)drawingBlock forSVGAAnimationWithKey:(NSString *)key;

@end

NS_ASSUME_NONNULL_END

```

`JFAnimationView.m`

```swift
//
//  JFAnimationView.m
//  AnimationDemo
//
//  Created by Japho on 2018/10/31.
//  Copyright Â© 2018 Japho. All rights reserved.
//

#import "JFAnimationView.h"
#import "SVGA.h"
#import "Lottie.h"

@interface JFAnimationView () <SVGAPlayerDelegate>

@property (nonatomic, strong) SVGAPlayer *svgaPlayer;
@property (nonatomic, strong) SVGAParser *svgaParser;
@property (nonatomic, strong) LOTAnimationView *lotAnimationView;
@property (nonatomic, assign) BOOL hasSVGALoad;
@property (nonatomic, assign) BOOL hasLottieLoad;

@end

@implementation JFAnimationView

- (instancetype)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    
    if (self)
    {
        _animationType = -1;
    }
    
    return self;
}

+ (instancetype)animationViewWithFrame:(CGRect)frame animationType:(JFAnimationType)animationType
{
    return [[JFAnimationView alloc] initWithFrame:frame animationType:animationType];
}

- (instancetype)initWithFrame:(CGRect)frame animationType:(JFAnimationType)animationType
{
    self = [super initWithFrame:frame];
    
    if (self)
    {
        self.animationType = animationType;
    }
    
    return self;
}

- (void)setAnimationResourceWithName:(NSString *)name bundle:(NSBundle *)bundle resourceCompliton:(nonnull JFAnimationResourceCompletionBlcok)resourceComplition
{
    NSArray *components = [name componentsSeparatedByString:@"."];
    name = components.firstObject;
    
    switch (self.animationType)
    {
        case AnimationTypeSVGA:
        {
            __weak __typeof(&*self)weakSelf = self;
            
            [self.svgaParser parseWithNamed:name inBundle:bundle completionBlock:^(SVGAVideoEntity * _Nonnull videoItem) {
                
                __strong __typeof(self)strongSelf = weakSelf;
                strongSelf.svgaPlayer.videoItem = videoItem;
                
                CGRect bounds = CGRectMake(0, 0, videoItem.videoSize.width, videoItem.videoSize.height);
                resourceComplition(bounds, YES);
                
            } failureBlock:^(NSError * _Nonnull error) {
                
                NSLog(@"Error: %@",error);
                resourceComplition(CGRectZero, NO);
                
            }];
            
            break;
        }
        case AnimationTypeLottie:
        {
            if (bundle == nil)
            {
                bundle = [NSBundle mainBundle];
            }
            
            LOTComposition *comp = [LOTComposition animationNamed:name inBundle:bundle];
            [self.lotAnimationView setSceneModel:comp];
            resourceComplition(comp.compBounds, YES);
            
            break;
        }
        default:
            break;
    }
}

- (void)setAnimationResourceWithUrlString:(NSString *)urlString resourceComplition:(JFAnimationResourceCompletionBlcok)resourceComplition
{
    switch (self.animationType)
    {
        case AnimationTypeSVGA:
        {
            __weak __typeof(&*self)weakSelf = self;
            
            NSData *data = [NSData dataWithContentsOfFile:urlString];
            
            [self.svgaParser parseWithData:data cacheKey:urlString completionBlock:^(SVGAVideoEntity * _Nonnull videoItem) {
                
                __strong __typeof(self)strongSelf = weakSelf;
                strongSelf.svgaPlayer.videoItem = videoItem;
                
                CGRect bounds = CGRectMake(0, 0, videoItem.videoSize.width, videoItem.videoSize.height);
                resourceComplition(bounds, YES);
                
            } failureBlock:^(NSError * _Nonnull error) {
                
                NSLog(@"Error: %@",error);
                
                resourceComplition(CGRectZero, NO);
                
            }];
            
            break;
        }
        case AnimationTypeLottie:
        {
            LOTComposition *laScene = [[LOTAnimationCache sharedCache] animationForKey:urlString];
            if (laScene)
            {
                laScene.cacheKey = urlString;
                [self.lotAnimationView setSceneModel:laScene];
                resourceComplition(laScene.compBounds, YES);
            }
            else
            {
                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^(void) {
                    
                    LOTComposition *laScene = [LOTComposition animationWithFilePath:urlString];
                    
                    dispatch_async(dispatch_get_main_queue(), ^(void) {
                        [[LOTAnimationCache sharedCache] addAnimation:laScene forKey:urlString];
                        laScene.cacheKey = urlString;
                        [self.lotAnimationView setSceneModel:laScene];
                        resourceComplition(laScene.compBounds, YES);
                    });
                });
            }
            
            break;
        }
        default:
            break;
    }
}

- (void)startAnimating
{
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer startAnimation];
    }
    else if (self.animationType == AnimationTypeLottie)
    {
        __weak __typeof(&*self)weakSelf = self;
        
        [self.lotAnimationView playWithCompletion:^(BOOL animationFinished) {
            
            __strong __typeof(self)strongSelf = weakSelf;
            
            if (animationFinished)
            {
                if (strongSelf.delegate && [strongSelf.delegate respondsToSelector:@selector(animationViewDidFinishedAnimation:)])
                {
                    [strongSelf.delegate animationViewDidFinishedAnimation:strongSelf];
                }
            }
            else
            {
                if (strongSelf.delegate && [strongSelf.delegate respondsToSelector:@selector(animationViewDidFailed:)])
                {
                    [strongSelf.delegate animationViewDidFailed:strongSelf];
                }
            }
        }];
    }
}

- (void)startAnimatingWithCompletion:(JFAnimationCompletionBlock)completion
{
    self.completionBlock = completion;
    
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer startAnimation];
    }
    else if (self.animationType == AnimationTypeLottie)
    {
        [self.lotAnimationView playWithCompletion:^(BOOL animationFinished) {
            
            self.completionBlock(animationFinished);
            
        }];
    }
}

- (void)stopAnimating
{
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer stopAnimation];
        
        if (self.delegate && [self.delegate respondsToSelector:@selector(animationViewDidFinishedAnimation:)])
        {
            [self.delegate animationViewDidFinishedAnimation:self];
        }
    }
    else if (self.animationType == AnimationTypeLottie)
    {
        [self.lotAnimationView stop];
    }
}

- (void)setImage:(UIImage *)image forSVGAAnimationWithKey:(NSString *)key
{
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer setImage:image forKey:key];
    }
}

- (void)setAttributedText:(NSAttributedString *)attributedText forSVGAAnimationWithKey:(NSString *)key
{
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer setAttributedText:attributedText forKey:key];
    }
}

- (void)setDrawingBlock:(SVGAPlayerDynamicDrawingBlock)drawingBlock forSVGAAnimationWithKey:(NSString *)key
{
    if (self.animationType == AnimationTypeSVGA)
    {
        [self.svgaPlayer setDrawingBlock:drawingBlock forKey:key];
    }
}

#pragma mark - --- SVGAPlayer Delegate ---

- (void)svgaPlayerDidFinishedAnimation:(SVGAPlayer *)player
{
    [player clear];

    if (self.delegate && [self.delegate respondsToSelector:@selector(animationViewDidFinishedAnimation:)])
    {
        [self.delegate animationViewDidFinishedAnimation:self];
    }
    
    if (self.completionBlock)
    {
        self.completionBlock(YES);
    }
}

#pragma mark - --- Setter & Getter ---

- (SVGAPlayer *)svgaPlayer
{
    if (!_svgaPlayer)
    {
        _svgaPlayer = [[SVGAPlayer alloc] initWithFrame:self.bounds];
        _svgaPlayer.contentMode = self.contentMode;
        _svgaPlayer.loops = 1;
        _svgaPlayer.clearsAfterStop = YES;
        _svgaPlayer.delegate = self;
    }
    
    return _svgaPlayer;
}

- (SVGAParser *)svgaParser
{
    if (!_svgaParser)
    {
        _svgaParser = [[SVGAParser alloc] init];
    }
    
    return _svgaParser;
}

- (LOTAnimationView *)lotAnimationView
{
    if (!_lotAnimationView)
    {
        _lotAnimationView = [[LOTAnimationView alloc] initWithFrame:self.bounds];
        _lotAnimationView.contentMode = self.contentMode;
    }
    
    return _lotAnimationView;
}

- (void)setLoopAnimation:(BOOL)loopAnimation
{
    _loopAnimation = loopAnimation;
    
    if (self.animationType == AnimationTypeSVGA)
    {
        self.svgaPlayer.loops = loopAnimation ? 0 : 1;
    }
    else if (self.animationType == AnimationTypeLottie)
    {
        self.lotAnimationView.loopAnimation = loopAnimation;
    }
}

- (void)setContentMode:(UIViewContentMode)contentMode
{
    [super setContentMode:contentMode];
    
    _lotAnimationView.contentMode = contentMode;
    _svgaPlayer.contentMode = contentMode;
}

- (void)setAnimationType:(JFAnimationType)animationType
{
    _animationType = animationType;
    
    if (animationType == AnimationTypeLottie)
    {
        if (!_hasLottieLoad)
        {
            [self addSubview:self.lotAnimationView];
            _hasLottieLoad = YES;
        }
        
        _lotAnimationView.hidden = NO;
        _svgaPlayer.hidden = YES;
    }
    else if (animationType == AnimationTypeSVGA)
    {
        if (!_hasSVGALoad)
        {
            [self addSubview:self.svgaPlayer];
            _hasSVGALoad = YES;
        }
        
        _lotAnimationView.hidden = YES;
        _svgaPlayer.hidden = NO;
    }
}

- (void)setFrame:(CGRect)frame
{
    [super setFrame:frame];
    
    _lotAnimationView.frame = CGRectMake(0, 0, frame.size.width, frame.size.height);
    _svgaPlayer.frame = CGRectMake(0, 0, frame.size.width, frame.size.height);
}

@end


```

## ç»“è¯­

å¤§æ¦‚ç®€å•çš„ä»‹ç»äº†å½“å‰æ¯”è¾ƒå¥½ç”¨çš„ä¸¤ä¸ªåŠ¨ç”»åŠ è½½åº“ï¼Œå¸Œæœ›å¤§å®¶å¯¹å¤§å®¶ç€æ‰‹å¼€å‘æœ‰æ‰€å¸®åŠ©ï¼Œå¦‚æœæœ‰é—®é¢˜ä¹Ÿå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ä¼šè¿™è”ç³»æˆ‘çš„é‚®ç®±ï¼Œæ”¶åˆ°åä¼šåŠæ—¶å›å¤ã€‚å–œæ¬¢çš„è€é“æ”¶è—ä¸‹ï¼ŒåŒå‡»666ã€‚å¥½äº†ï¼Œæˆ‘ä»¬æœ¬æœŸåšå®¢åˆ°æ­¤ç»“æŸï¼Œæˆ‘ä»¬ä¸‹æ¬¡å†è§ã€‚

![](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1541506562699&di=92c038149b2185df3db6216ac3f69259&imgtype=0&src=http%3A%2F%2Fc.hiphotos.baidu.com%2Fimage%2Fpic%2Fitem%2F8b13632762d0f703fb8b190102fa513d2697c536.jpg)
